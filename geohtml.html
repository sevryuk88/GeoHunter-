<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoHunter</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=752def06-b6ee-4762-a047-ccb35a7c4e6f&lang=ru_RU"></script>
    <style>
        :root {
            --primary: #4CAF50;
            --secondary: #2196F3;
            --premium: #7B1FA2;
            --background: #121212;
            --surface: #1E1E1E;
            --on-surface: #FFFFFF;
            --error: #CF6679;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        body {
            background: var(--background);
            color: var(--on-surface);
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 16px;
        }
        
        .screen {
            display: none;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }
        
        .screen.active {
            display: flex;
        }
        
        /* Language Switcher */
        .language-switcher {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1000;
            display: flex;
            gap: 8px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        
        .lang-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .lang-btn.active {
            background: rgba(76, 175, 80, 0.3);
            border-color: var(--primary);
        }
        
        /* Welcome Screen */
        .welcome-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }
        
        .logo {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        .title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 16px;
        }
        
        .subtitle {
            font-size: 16px;
            margin-bottom: 30px;
            opacity: 0.8;
        }
        
        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 8px 0;
            width: 100%;
            max-width: 300px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #2E7D32);
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        
        .btn-secondary {
            background: var(--surface);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .btn-premium {
            background: linear-gradient(135deg, var(--premium), #6A1B9A);
            color: white;
            box-shadow: 0 4px 15px rgba(123, 31, 162, 0.3);
        }
        
        /* Mode Selection */
        .mode-options {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 100%;
            max-width: 400px;
            margin: 20px 0;
        }
        
        .mode-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .mode-card.selected {
            border-color: var(--primary);
            background: rgba(76, 175, 80, 0.1);
        }
        
        .mode-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .mode-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        
        .mode-name {
            font-size: 18px;
            font-weight: bold;
        }
        
        .mode-price {
            margin-left: auto;
            background: rgba(76, 175, 80, 0.2);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
        }
        
        .mode-details {
            margin-top: 10px;
        }
        
        .mode-detail {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
            color: #ccc;
        }
        
        /* Game Screen */
        .game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--surface);
            border-radius: 12px;
            margin-bottom: 16px;
        }
        
        .balance {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary);
        }
        
        .mode-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .mode-badge.economy { background: var(--primary); color: white; }
        .mode-badge.standard { background: var(--secondary); color: white; }
        .mode-badge.premium { background: var(--premium); color: white; }
        
        .map-container {
            flex: 1;
            background: #2A2A2A;
            border-radius: 12px;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }
        
        #map {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }
        
        .map-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 2;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 8px;
            color: white;
            backdrop-filter: blur(5px);
        }
        
        .proximity-indicator {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 20px;
            color: white;
            z-index: 2;
            backdrop-filter: blur(5px);
            display: none;
        }
        
        .progress-bar {
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #FF6B6B, #FF8E53);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .game-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        /* Payment Screen */
        .payment-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
            max-width: 400px;
            margin: 20px 0;
        }
        
        .payment-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .payment-card:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .payment-amount {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .payment-bonus {
            font-size: 14px;
            color: var(--primary);
        }
        
        /* Stats Screen */
        .stats-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .stat-card {
            background: var(--surface);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 4px;
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 14px;
            color: #aaa;
        }
        
        /* Results Screen */
        .results-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            text-align: center;
            padding: 20px;
        }
        
        /* Navigation */
        .nav-back {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 80%;
        }
        
        @keyframes slideIn {
            from { transform: translate(-50%, -20px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="language-switcher">
        <button class="lang-btn active" data-lang="en">EN</button>
        <button class="lang-btn" data-lang="ru">RU</button>
    </div>

    <div class="container">
        <!-- Welcome Screen -->
        <div class="screen active" id="welcome-screen">
            <div class="welcome-container">
                <div class="logo">🗺️</div>
                <h1 class="title" data-i18n="welcomeTitle">GeoHunter</h1>
                <p class="subtitle" data-i18n="welcomeSubtitle">Find hidden treasures around you!</p>
                
                <button class="btn btn-primary" id="btn-start" data-i18n="getStarted">Get Started</button>
                <button class="btn btn-secondary" id="btn-rules" data-i18n="viewRules">View Rules</button>
            </div>
        </div>

        <!-- Mode Selection Screen -->
        <div class="screen" id="mode-screen">
            <div class="nav-back" onclick="showScreen('welcome-screen')">←</div>
            
            <h2 class="title" data-i18n="chooseMode">Choose Game Mode</h2>
            
            <div class="mode-options">
                <div class="mode-card" data-mode="economy">
                    <div class="mode-header">
                        <div class="mode-icon">🟢</div>
                        <div class="mode-name" data-i18n="economy">Economy</div>
                        <div class="mode-price">3$</div>
                    </div>
                    <div class="mode-details">
                        <div class="mode-detail">
                            <span data-i18n="prizes">Prizes:</span>
                            <span>1-10$</span>
                        </div>
                        <div class="mode-detail">
                            <span data-i18n="winChance">Win chance:</span>
                            <span>12%</span>
                        </div>
                    </div>
                </div>
                
                <div class="mode-card" data-mode="standard">
                    <div class="mode-header">
                        <div class="mode-icon">🔵</div>
                        <div class="mode-name" data-i18n="standard">Standard</div>
                        <div class="mode-price">5$</div>
                    </div>
                    <div class="mode-details">
                        <div class="mode-detail">
                            <span data-i18n="prizes">Prizes:</span>
                            <span>3-15$</span>
                        </div>
                        <div class="mode-detail">
                            <span data-i18n="winChance">Win chance:</span>
                            <span>18%</span>
                        </div>
                    </div>
                </div>
                
                <div class="mode-card" data-mode="premium">
                    <div class="mode-header">
                        <div class="mode-icon">🟣</div>
                        <div class="mode-name" data-i18n="premium">Premium</div>
                        <div class="mode-price">7$</div>
                    </div>
                    <div class="mode-details">
                        <div class="mode-detail">
                            <span data-i18n="prizes">Prizes:</span>
                            <span>5-20$</span>
                        </div>
                        <div class="mode-detail">
                            <span data-i18n="winChance">Win chance:</span>
                            <span>25%</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary" id="btn-select-mode" disabled data-i18n="selectMode">Select Mode</button>
        </div>

        <!-- Game Screen -->
        <div class="screen" id="game-screen">
            <div class="nav-back" onclick="showScreen('mode-screen')">←</div>
            
            <div class="game-container">
                <div class="game-header">
                    <div class="balance" id="game-balance">100 $</div>
                    <div class="mode-badge economy" id="game-mode-badge" data-i18n="economy">Economy</div>
                </div>
                
                <div class="map-container">
                    <div id="map"></div>
                    <div class="map-overlay">
                        <div data-i18n="geospotsFound">Found: </div>
                        <span id="found-count">0</span>/<span id="total-count">5</span>
                    </div>
                    <div class="proximity-indicator" id="proximity-indicator">
                        <div data-i18n="approachingSpot">Approaching geospot</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="proximity-progress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="game-controls">
                    <button class="btn btn-secondary" onclick="updateLocation()" data-i18n="updateLocation">Update Location</button>
                    <button class="btn btn-primary" onclick="endGame()" data-i18n="endGame">End Game</button>
                </div>
            </div>
        </div>

        <!-- Payment Screen -->
        <div class="screen" id="payment-screen">
            <div class="nav-back" onclick="showScreen('welcome-screen')">←</div>
            
            <h2 class="title" data-i18n="addFunds">Add Funds</h2>
            
            <div class="payment-options">
                <div class="payment-card">
                    <div class="payment-amount">5$</div>
                    <div class="payment-bonus" data-i18n="noBonus">No bonus</div>
                </div>
                
                <div class="payment-card">
                    <div class="payment-amount">10$</div>
                    <div class="payment-bonus" data-i18n="bonus1">+1$ bonus</div>
                </div>
                
                <div class="payment-card">
                    <div class="payment-amount">20$</div>
                    <div class="payment-bonus" data-i18n="bonus3">+3$ bonus</div>
                </div>
            </div>
            
            <button class="btn btn-primary" data-i18n="addFunds">Add Funds</button>
        </div>

        <!-- Results Screen -->
        <div class="screen" id="results-screen">
            <div class="nav-back" onclick="showScreen('welcome-screen')">←</div>
            
            <div class="results-container">
                <div class="logo">🏆</div>
                <h2 class="title" data-i18n="gameCompleted">Game Completed!</h2>
                
                <div class="stats-grid" style="margin: 20px 0;">
                    <div class="stat-card">
                        <div class="stat-value" id="results-found">5/5</div>
                        <div class="stat-label" data-i18n="geospotsFound">Geospots Found</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-value" id="results-prize">0 $</div>
                        <div class="stat-label" data-i18n="prizesWon">Prizes Won</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-value" id="results-total">100 $</div>
                        <div class="stat-label" data-i18n="totalBalance">Total Balance</div>
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="showScreen('mode-screen')" data-i18n="playAgain">Play Again</button>
            </div>
        </div>

        <!-- Rules Screen -->
        <div class="screen" id="rules-screen">
            <div class="nav-back" onclick="showScreen('welcome-screen')">←</div>
            
            <h2 class="title" data-i18n="gameRules">Game Rules</h2>
            
            <div style="overflow-y: auto; padding: 16px;">
                <ol style="margin-left: 20px; margin-bottom: 20px;">
                    <li data-i18n="rule1">Choose a game mode and make a deposit</li>
                    <li data-i18n="rule2">Start the game by sharing your location</li>
                    <li data-i18n="rule3">5 hidden geospots will be created within 100m radius</li>
                    <li data-i18n="rule4">Move around and search for the spots</li>
                    <li data-i18n="rule5">When you approach a spot, you'll get notifications</li>
                    <li data-i18n="rule6">Find all spots and collect prizes!</li>
                </ol>
                
                <button class="btn btn-primary" onclick="showScreen('welcome-screen')" data-i18n="understand">I Understand</button>
            </div>
        </div>
    </div>

    <script>
    // В начале скрипта добавьте:
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('user_id');
    const demoMode = urlParams.get('demo_mode') === 'True';
    
    
        // Translations
    const translations = {
        en: {
            welcomeTitle: "GeoHunter",
            welcomeSubtitle: "Find hidden treasures around you!",
            getStarted: "Get Started",
            viewRules: "View Rules",
            chooseMode: "Choose Game Mode",
            economy: "Economy",
            standard: "Standard",
            premium: "Premium",
            prizes: "Prizes:",
            winChance: "Win chance:",
            selectMode: "Select Mode",
            updateLocation: "Update Location",
            endGame: "End Game",
            addFunds: "Add Funds",
            noBonus: "No bonus",
            bonus1: "+1$ bonus",
            bonus3: "+3$ bonus",
            statistics: "Statistics",
            gamesPlayed: "Games Played",
            prizesWon: "Prizes Won",
            totalWinnings: "Total Winnings",
            timePlayed: "Time Played",
            backToMenu: "Back to Menu",
            gameRules: "Game Rules",
            rule1: "Choose a game mode and make a deposit",
            rule2: "Start the game by sharing your location",
            rule3: "5 hidden geospots will be created within 100m radius",
            rule4: "Move around and search for the spots",
            rule5: "When you approach a spot, you'll get notifications",
            rule6: "Find all spots and collect prizes!",
            understand: "I Understand",
            mapLoading: "Loading map...",
            geospotsFound: "Found:",
            approachingSpot: "Approaching geospot",
            foundPrize: "🎉 Found prize: {prize}$!",
            emptySpot: "🤷‍♂️ Empty spot",
            gameCompleted: "🎊 Game completed! All spots found!",
            gameCompletedTitle: "Game Completed!",
            playAgain: "Play Again",
            totalBalance: "Total Balance",
            loadingLocation: "Getting your location...",
            mapLoadError: "Failed to load maps. Please check your internet connection.",
            retry: "Try again"
        },
        ru: {
            welcomeTitle: "GeoHunter",
            welcomeSubtitle: "Найди скрытые сокровища вокруг себя!",
            getStarted: "Начать",
            viewRules: "Правила",
            chooseMode: "Выберите режим игры",
            economy: "Эконом",
            standard: "Стандарт",
            premium: "Премиум",
            prizes: "Призы:",
            winChance: "Шанс выигрыша:",
            selectMode: "Выбрать режим",
            updateLocation: "Обновить позицию",
            endGame: "Завершить игру",
            addFunds: "Пополнить счет",
            noBonus: "Без бонуса",
            bonus1: "+1$ бонус",
            bonus3: "+3$ бонус",
            statistics: "Статистика",
            gamesPlayed: "Сыграно игр",
            prizesWon: "Выиграно призов",
            totalWinnings: "Общий выигрыш",
            timePlayed: "Время игры",
            backToMenu: "В меню",
            gameRules: "Правила игры",
            rule1: "Выберите режим игры и внесите депозит",
            rule2: "Запустите игру, отправив свою геопозицию",
            rule3: "5 скрытых геометок будут созданы в радиусе 100м",
            rule4: "Перемещайтесь и ищите метки",
            rule5: "При приближении к метке вы получите уведомления",
            rule6: "Найдите все метки и соберите призы!",
            understand: "Понятно",
            mapLoading: "Загрузка карты...",
            geospotsFound: "Найдено:",
            approachingSpot: "Приближаетесь к геометке",
            foundPrize: "🎉 Найден приз: {prize}$!",
            emptySpot: "🤷‍♂️ Пустая метка",
            gameCompleted: "🎊 Игра завершена! Все метки найдены!",
            gameCompletedTitle: "Игра Завершена!",
            playAgain: "Играть снова",
            totalBalance: "Общий баланс",
            loadingLocation: "Получаем ваше местоположение...",
            mapLoadError: "Не удалось загрузить карты. Проверьте подключение к интернету.",
            retry: "Попробовать снова"
        }
    };

    // Game modes configuration
    const GAME_MODES = {
        'economy': {
            'name': {en: 'Economy', ru: 'Эконом'},
            'entry_fee': 3,
            'radius': 30,
            'min_prize': 1,
            'max_prize': 10,
            'win_probability': 0.12
        },
        'standard': {
            'name': {en: 'Standard', ru: 'Стандарт'},
            'entry_fee': 5,
            'radius': 50,
            'min_prize': 3,
            'max_prize': 15,
            'win_probability': 0.18
        },
        'premium': {
            'name': {en: 'Premium', ru: 'Премиум'},
            'entry_fee': 7,
            'radius': 70,
            'min_prize': 5,
            'max_prize': 20,
            'win_probability': 0.25
        }
    };

    // Game state
    let currentLanguage = 'en';
    let selectedMode = null;
    let gameState = {
        balance: 100,
        mode: null,
        center: null,
        geospots: [],
        foundSpots: [],
        gameActive: false,
        userMarker: null,
        circle: null,
        map: null,
        watchId: null
    };

    // Initialize the app
    function initApp() {
        // Set up language switcher
        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                setLanguage(this.dataset.lang);
            });
        });

        // Set up navigation
        document.getElementById('btn-start').addEventListener('click', function() {
            showScreen('mode-screen');
        });

        document.getElementById('btn-rules').addEventListener('click', function() {
            showScreen('rules-screen');
        });

        // Set up mode selection
        document.querySelectorAll('.mode-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                selectedMode = this.dataset.mode;
                document.getElementById('btn-select-mode').disabled = false;
            });
        });

        document.getElementById('btn-select-mode').addEventListener('click', function() {
            startGame();
        });

        // Set initial language
        setLanguage(currentLanguage);
    }

    // Change language
    function setLanguage(lang) {
        currentLanguage = lang;
        
        // Update active button
        document.querySelectorAll('.lang-btn').forEach(btn => {
            if (btn.dataset.lang === lang) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
        
        // Update all translatable elements
        document.querySelectorAll('[data-i18n]').forEach(element => {
            const key = element.getAttribute('data-i18n');
            if (translations[lang][key]) {
                element.textContent = translations[lang][key];
            }
        });
    }

    // Show specific screen
    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.remove('active');
        });
        document.getElementById(screenId).classList.add('active');
    }

    // Get mode price
    function getModePrice(mode) {
        const prices = {
            'economy': 3,
            'standard': 5,
            'premium': 7
        };
        return prices[mode] || 0;
    }

    // Start game
    function startGame() {
        if (gameState.balance < getModePrice(selectedMode)) {
            showScreen('payment-screen');
            return;
        }
        
        // Deduct game cost
        gameState.balance -= getModePrice(selectedMode);
        updateBalance();
        
        gameState.mode = selectedMode;
        gameState.foundSpots = [];
        gameState.gameActive = true;
        
        // Update UI
        document.getElementById('game-mode-badge').textContent = translations[currentLanguage][selectedMode];
        document.getElementById('game-mode-badge').className = `mode-badge ${selectedMode}`;
        document.getElementById('total-count').textContent = '5';
        document.getElementById('found-count').textContent = '0';
        
        showScreen('game-screen');
        
        // Initialize game
        initGame();
    }
    
    // Добавьте функцию для запроса баланса
    async function fetchBalance() {
        // В реальном приложении здесь должен быть API-запрос к боту
        // Для демо-режима используем начальный баланс из параметров
        return demoMode ? 100 : 0; // Заглушка
    }
    
    // Initialize game
    async function initGame() {
        // Show loading message
        // Запрашиваем баланс у бота
        gameState.balance = await fetchBalance();
        updateBalance();
        showToast(translations[currentLanguage].loadingLocation);
        
        // Get user location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                position => {
                    const coords = [position.coords.latitude, position.coords.longitude];
                    gameState.center = coords;
                    initMap();
                },
                error => {
                    console.error('Geolocation error:', error);
                    // Use default coordinates
                    gameState.center = [55.7558, 37.6173];
                    showToast('Using default location. Please enable GPS for better experience.');
                    initMap();
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        } else {
            alert('Geolocation is not supported by this browser.');
            // Use default coordinates
            gameState.center = [55.7558, 37.6173];
            initMap();
        }
    }

    // Initialize map
    function initMap() {
        // Check if Yandex Maps is loaded
        if (typeof ymaps === 'undefined') {
            console.error('Yandex Maps not loaded');
            loadYandexMaps();
            return;
        }
        
        ymaps.ready(() => {
            try {
                // Initialize map
                gameState.map = new ymaps.Map('map', {
                    center: gameState.center,
                    zoom: 16,
                    controls: ['zoomControl']
                });
                
                // Add user marker
                gameState.userMarker = new ymaps.Placemark(gameState.center, {}, {
                    preset: 'islands#blueCircleDotIcon',
                    iconColor: '#2196F3'
                });
                
                gameState.map.geoObjects.add(gameState.userMarker);
                
                // Add search radius circle
                const modeConfig = GAME_MODES[gameState.mode];
                gameState.circle = new ymaps.Circle([
                    gameState.center,
                    modeConfig.radius
                ], {}, {
                    fillColor: "rgba(33, 150, 243, 0.2)",
                    strokeColor: "#2196F3",
                    strokeOpacity: 0.8,
                    strokeWidth: 2
                });
                
                gameState.map.geoObjects.add(gameState.circle);
                
                // Generate geospots
                generateGeospots();
                
                // Add geospots to map
                addGeospotsToMap();
                
                // Start location tracking
                startLocationTracking();
                
            } catch (e) {
                console.error('Map initialization error:', e);
                showToast('Failed to initialize map');
            }
        });
    }

    // Обновляем функцию loadYandexMaps
    function loadYandexMaps() {
        const script = document.createElement('script');
        script.src = 'https://api-maps.yandex.ru/2.1/?apikey=752def06-b6ee-4762-a047-ccb35a7c4e6f&lang=ru_RU';
        script.onload = function() {
            console.log('Yandex Maps loaded successfully');
            // Retry initialization after maps are loaded
            initMap();
        };
        script.onerror = function() {
            console.error('Failed to load Yandex Maps');
            
            // Показываем сообщение об ошибке
            const mapContainer = document.querySelector('.map-container');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'map-error';
            errorDiv.innerHTML = `
                <h3>${translations[currentLanguage].mapLoadError || 'Failed to load maps'}</h3>
                <button onclick="loadYandexMaps()">${translations[currentLanguage].retry || 'Retry'}</button>
            `;
            errorDiv.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                text-align: center;
                z-index: 10;
                background: rgba(0,0,0,0.8);
                padding: 20px;
                border-radius: 10px;
            `;
            
            mapContainer.appendChild(errorDiv);
        };
        document.head.appendChild(script);
    }

    // Generate geospots
    function generateGeospots() {
        const modeConfig = GAME_MODES[gameState.mode];
        gameState.geospots = [];
        
        for (let i = 0; i < 5; i++) {
            // Generate random coordinates within radius
            const angle = Math.random() * Math.PI * 2;
            const distance = Math.random() * modeConfig.radius;
            const earthRadius = 6371000; // Earth radius in meters
            
            const dx = distance * Math.cos(angle);
            const dy = distance * Math.sin(angle);
            
            const deltaLat = (dy / earthRadius) * (180 / Math.PI);
            const deltaLon = (dx / (earthRadius * Math.cos(Math.PI * gameState.center[0] / 180))) * (180 / Math.PI);
            
            const newLat = gameState.center[0] + deltaLat;
            const newLon = gameState.center[1] + deltaLon;
            
            // Determine if this spot has a prize
            const hasPrize = Math.random() < modeConfig.win_probability;
            const prizeAmount = hasPrize ? 
                Math.floor(Math.random() * (modeConfig.max_prize - modeConfig.min_prize + 1)) + modeConfig.min_prize : 
                0;
            
            gameState.geospots.push({
                id: i,
                coords: [newLat, newLon],
                hasPrize: hasPrize,
                prizeAmount: prizeAmount,
                found: false,
                marker: null
            });
        }
    }

    // Add geospots to map
    function addGeospotsToMap() {
        if (!gameState.map) {
            console.error('Map is not initialized');
            return;
        }
        
        // Add new geospots
        gameState.geospots.forEach(spot => {
            const placemark = new ymaps.Placemark(spot.coords, {
                balloonContent: spot.hasPrize ? 
                    `${translations[currentLanguage].prizes.replace(':', '')}: ${spot.prizeAmount}$` : 
                    translations[currentLanguage].emptySpot
            }, {
                preset: spot.hasPrize ? 'islands#redIcon' : 'islands#grayIcon'
            });
            
            spot.marker = placemark;
            gameState.map.geoObjects.add(placemark);
        });
        
        console.log('Geospots added to map:', gameState.geospots.length);
    }

    // Start location tracking
    function startLocationTracking() {
        if (gameState.watchId) {
            navigator.geolocation.clearWatch(gameState.watchId);
        }
        
        gameState.watchId = navigator.geolocation.watchPosition(
            position => {
                const coords = [position.coords.latitude, position.coords.longitude];
                updateUserPosition(coords);
                checkProximity(coords);
            },
            error => {
                console.error('Geolocation error:', error);
            },
            {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            }
        );
    }

    // Update user position
    function updateUserPosition(coords) {
        if (gameState.userMarker) {
            gameState.userMarker.geometry.setCoordinates(coords);
        }
        
        // Update circle position if it exists
        if (gameState.circle) {
            const modeConfig = GAME_MODES[gameState.mode];
            gameState.circle.geometry.setCoordinates(coords);
            gameState.circle.geometry.setRadius(modeConfig.radius);
        }
        
        // Center map on user
        if (gameState.map) {
            gameState.map.setCenter(coords);
        }
    }

    // Check proximity to geospots
    function checkProximity(userCoords) {
        let closestDistance = Infinity;
        let closestSpot = null;
        
        gameState.geospots.forEach(spot => {
            if (spot.found) return;
            
            const distance = calculateDistance(
                userCoords[0], userCoords[1],
                spot.coords[0], spot.coords[1]
            );
            
            if (distance < closestDistance) {
                closestDistance = distance;
                closestSpot = spot;
            }
            
            // Check if we're close enough to "find" the spot
            if (distance <= 10) { // 10 meters
                foundGeospot(spot);
            }
        });
        
        // Show proximity indicator
        if (closestSpot && closestDistance <= 50) {
            const progress = Math.max(0, 100 - (closestDistance / 50) * 100);
            showProximityIndicator(progress);
        } else {
            hideProximityIndicator();
        }
    }

    // Show proximity indicator
    function showProximityIndicator(progress) {
        const indicator = document.getElementById('proximity-indicator');
        const progressBar = document.getElementById('proximity-progress');
        
        if (indicator && progressBar) {
            indicator.style.display = 'block';
            progressBar.style.width = `${progress}%`;
        }
    }

    // Hide proximity indicator
    function hideProximityIndicator() {
        const indicator = document.getElementById('proximity-indicator');
        if (indicator) {
            indicator.style.display = 'none';
        }
    }

    // Handle found geospot
    function foundGeospot(spot) {
        if (spot.found) return;
        
        spot.found = true;
        gameState.foundSpots.push(spot);
        
        // Update marker
        if (spot.marker) {
            spot.marker.options.set('preset', 'islands#greenIcon');
        }
        
        // Award prize
        if (spot.hasPrize) {
            gameState.balance += spot.prizeAmount;
            updateBalance();
            
            // Show notification
            showToast(translations[currentLanguage].foundPrize.replace('{prize}', spot.prizeAmount));
        } else {
            showToast(translations[currentLanguage].emptySpot);
        }
        
        // Update counter
        updateFoundCounter();
        
        // Check if game is complete
        if (gameState.foundSpots.length === gameState.geospots.length) {
            endGame(true);
        }
    }

    // Update found counter
    function updateFoundCounter() {
        document.getElementById('found-count').textContent = gameState.foundSpots.length;
        document.getElementById('results-found').textContent = `${gameState.foundSpots.length}/5`;
    }

    // Update balance
    function updateBalance() {
        document.getElementById('game-balance').textContent = gameState.balance + ' $';
        document.getElementById('results-total').textContent = gameState.balance + ' $';
    }

    // Calculate total prize
    function calculateTotalPrize() {
        return gameState.foundSpots
            .filter(spot => spot.hasPrize)
            .reduce((sum, spot) => sum + spot.prizeAmount, 0);
    }
    
    
    // Функция для отправки данных боту
    function sendDataToBot(data) {
        // Добавляем user_id в данные
        data.user_id = userId;
        data.demo_mode = demoMode;
        
        if (window.Telegram && Telegram.WebApp) {
            Telegram.WebApp.sendData(JSON.stringify(data));
        } else {
            console.log('Data to be sent to bot:', data);
            // Для тестирования вне Telegram
            alert('Данные для отправки: ' + JSON.stringify(data));
        }
    }

    // Обновляем функцию endGame
    function endGame(isComplete = false) {
        if (gameState.watchId) {
            navigator.geolocation.clearWatch(gameState.watchId);
            gameState.watchId = null;
        }
        
        if (isComplete) {
            const totalPrize = calculateTotalPrize();
            
            // Отправляем результаты игры боту
            const gameData = {
                type: 'game_result',
                mode: gameState.mode,
                entry_fee: getModePrice(gameState.mode),
                prize_won: totalPrize,
                found_geospots: gameState.foundSpots.map(spot => ({
                    has_prize: spot.hasPrize,
                    prize_amount: spot.prizeAmount
                }))
            };
            
            sendDataToBot(gameData);
            
            // Показываем результаты
            document.getElementById('results-prize').textContent = totalPrize + ' $';
            showToast(translations[currentLanguage].gameCompleted);
            
            // Показываем экран результатов
            setTimeout(() => {
                showScreen('results-screen');
            }, 2000);
        } else {
            showScreen('mode-screen');
        }
        
        gameState.gameActive = false;
    }
    
    // Добавляем обработчик для кнопки пополнения счета
    function setupPaymentHandlers() {
        document.querySelectorAll('.payment-card').forEach(card => {
            card.addEventListener('click', function() {
                const amount = parseFloat(this.querySelector('.payment-amount').textContent.replace('$', ''));
                
                const paymentData = {
                    type: 'payment_request',
                    amount: amount
                };
                
                sendDataToBot(paymentData);
            });
        });
    }

    // Calculate distance between coordinates (in meters)
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371000; // Earth radius in meters
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        
        const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
            Math.sin(dLon/2) * Math.sin(dLon/2);
        
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    // Update location manually
    function updateLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                position => {
                    const coords = [position.coords.latitude, position.coords.longitude];
                    updateUserPosition(coords);
                    checkProximity(coords);
                },
                error => {
                    console.error('Geolocation error:', error);
                    showToast('Location update failed');
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        }
    }
    


    // Show toast notification
    function showToast(message) {
        // Remove existing toasts
        document.querySelectorAll('.toast').forEach(toast => toast.remove());
        
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            if (toast.parentNode) {
                document.body.removeChild(toast);
            }
        }, 3000);
    }

    // Инициализируем обработчики платежей при загрузке
    document.addEventListener('DOMContentLoaded', function() {
        initApp();
        setupPaymentHandlers(); // Добавляем эту строку
    });
</script>
</html>